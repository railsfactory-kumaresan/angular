require "spec_helper"

describe EmailActivity do

  before(:each) do
    @biz_user = FactoryGirl.create(:user, :default_biz_user)
    @biz_customer_info = FactoryGirl.create(:business_customer_info, user: @biz_user,:status => nil)
    @category = CategoryType.first
    @question = FactoryGirl.create(:question, :year_wise_expire, user: @biz_user,category_type_id: @category.id)
    @monthly_question = FactoryGirl.create(:question, :month_wise_expire, user: @biz_user,category_type_id: @category.id)
    @weekly_question = FactoryGirl.create(:question, :week_wise_expire, user: @biz_user,category_type_id: @category.id)
  end

  it { should belong_to(:user) }
  it { should belong_to(:question) }
  it { should belong_to(:business_customer_info) }

  describe "Open activity" do
    it "should save the mandrill payload activity for open if activity not exist" do
        data = [{"event"=>"open","ts"=>1424676009,"user_agent"=>"Mozilla\/5.0 (X11; Linux i686; rv=>31.0) Gecko\/20100101 Thunderbird\/31.4.0 Lightning\/3.3.2","user_agent_parsed"=>{"type"=>"Email Client","ua_family"=>"Thunderbird","ua_name"=>"Thunderbird 31.4.0","ua_version"=>"31.4.0","ua_url"=>"http=>\/\/www.mozilla.com\/en-US\/thunderbird\/","ua_company"=>"Mozilla Foundation","ua_company_url"=>"http=>\/\/www.mozilla.org\/","ua_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/thunderbird.png","os_family"=>"Linux","os_name"=>"Linux","os_url"=>"http=>\/\/en.wikipedia.org\/wiki\/Linux","os_company"=>"","os_company_url"=>"","os_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/linux.png","mobile"=>false},"ip"=>"111.93.148.94","location"=>{"country_short"=>"IN","country"=>"India","region"=>"Karnataka","city"=>"Bangalore","latitude"=>12.9762296677,"longitude"=>77.6032867432,"postal_code"=>"-","timezone"=>"+05=>30"},"_id"=>"f8e53b84370943afad0eef724860b0da","msg"=>{"ts"=>1424348720,"_id"=>"f8e53b84370943afad0eef724860b0da","state"=>"sent","subject"=>"3rd round","email"=>"#{@biz_customer_info.email}","tags"=>[],"opens"=>[{"ts"=>1424351055,"ip"=>"1.39.61.176","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109","location"=>"Maharashtra, IN"},{"ts"=>1424353602,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424353336,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424352956,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357103,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357106,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424676009,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"}],"clicks"=>[{"ts"=>1424351055,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"1.39.61.176","location"=>"Maharashtra, IN","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109"},{"ts"=>1424352960,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Chrome\/Chrome 40.0.2214.111"}],"smtp_events"=>[{"ts"=>1424348722,"type"=>"sent","diag"=>"250 2.0.0 uCRM1p0050GC7EE01 - uCRM1p0050GC7EE01CRMl8 mail accepted for delivery","source_ip"=>"198.2.132.12","destination_ip"=>"182.50.144.66","size"=>18929}],"subaccount"=>"cust-34","resends"=>[],"_version"=>"cbowxAqolAD54zD8LR4D1g","metadata"=>{"question_id"=>"#{@question.id}","campaign_name"=>"3rd round","user_id"=>"#{@biz_user.id}"},"sender"=>"kumareshc10@gmail.com","template"=>""}}]
        EmailActivity.save_payload(data)
        EmailActivity.all.count.should eql(1)
    end
    it "should update the mandrill payload activity for open if activity exist" do
        FactoryGirl.create(:email_activity,user_id: @biz_user.id,business_customer_info_id: @biz_customer_info.id, question_id: @monthly_question.id)
        data = [{"event"=>"open","ts"=>1424676009,"user_agent"=>"Mozilla\/5.0 (X11; Linux i686; rv=>31.0) Gecko\/20100101 Thunderbird\/31.4.0 Lightning\/3.3.2","user_agent_parsed"=>{"type"=>"Email Client","ua_family"=>"Thunderbird","ua_name"=>"Thunderbird 31.4.0","ua_version"=>"31.4.0","ua_url"=>"http=>\/\/www.mozilla.com\/en-US\/thunderbird\/","ua_company"=>"Mozilla Foundation","ua_company_url"=>"http=>\/\/www.mozilla.org\/","ua_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/thunderbird.png","os_family"=>"Linux","os_name"=>"Linux","os_url"=>"http=>\/\/en.wikipedia.org\/wiki\/Linux","os_company"=>"","os_company_url"=>"","os_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/linux.png","mobile"=>false},"ip"=>"111.93.148.94","location"=>{"country_short"=>"IN","country"=>"India","region"=>"Karnataka","city"=>"Bangalore","latitude"=>12.9762296677,"longitude"=>77.6032867432,"postal_code"=>"-","timezone"=>"+05=>30"},"_id"=>"f8e53b84370943afad0eef724860b0da","msg"=>{"ts"=>1424348720,"_id"=>"f8e53b84370943afad0eef724860b0da","state"=>"sent","subject"=>"3rd round","email"=>"#{@biz_customer_info.email}","tags"=>[],"opens"=>[{"ts"=>1424351055,"ip"=>"1.39.61.176","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109","location"=>"Maharashtra, IN"},{"ts"=>1424353602,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424353336,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424352956,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357103,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357106,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424676009,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"}],"clicks"=>[{"ts"=>1424351055,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"1.39.61.176","location"=>"Maharashtra, IN","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109"},{"ts"=>1424352960,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Chrome\/Chrome 40.0.2214.111"}],"smtp_events"=>[{"ts"=>1424348722,"type"=>"sent","diag"=>"250 2.0.0 uCRM1p0050GC7EE01 - uCRM1p0050GC7EE01CRMl8 mail accepted for delivery","source_ip"=>"198.2.132.12","destination_ip"=>"182.50.144.66","size"=>18929}],"subaccount"=>"cust-34","resends"=>[],"_version"=>"cbowxAqolAD54zD8LR4D1g","metadata"=>{"question_id"=>"#{@monthly_question.id}","campaign_name"=>"3rd round","user_id"=>"#{@biz_user.id}"},"sender"=>"kumareshc10@gmail.com","template"=>""}}]
        EmailActivity.save_payload(data)
        EmailActivity.last.opens.should eql(2)
    end
  end

  describe "Click activity" do
     it "should save the mandrill payload activity for click if activity not exist" do
       data = [{"event"=>"click","ts"=>1424676009,"user_agent"=>"Mozilla\/5.0 (X11; Linux i686; rv=>31.0) Gecko\/20100101 Thunderbird\/31.4.0 Lightning\/3.3.2","user_agent_parsed"=>{"type"=>"Email Client","ua_family"=>"Thunderbird","ua_name"=>"Thunderbird 31.4.0","ua_version"=>"31.4.0","ua_url"=>"http=>\/\/www.mozilla.com\/en-US\/thunderbird\/","ua_company"=>"Mozilla Foundation","ua_company_url"=>"http=>\/\/www.mozilla.org\/","ua_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/thunderbird.png","os_family"=>"Linux","os_name"=>"Linux","os_url"=>"http=>\/\/en.wikipedia.org\/wiki\/Linux","os_company"=>"","os_company_url"=>"","os_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/linux.png","mobile"=>false},"ip"=>"111.93.148.94","location"=>{"country_short"=>"IN","country"=>"India","region"=>"Karnataka","city"=>"Bangalore","latitude"=>12.9762296677,"longitude"=>77.6032867432,"postal_code"=>"-","timezone"=>"+05=>30"},"_id"=>"f8e53b84370943afad0eef724860b0da","msg"=>{"ts"=>1424348720,"_id"=>"f8e53b84370943afad0eef724860b0da","state"=>"sent","subject"=>"3rd round","email"=>"#{@biz_customer_info.email}","tags"=>[],"opens"=>[{"ts"=>1424351055,"ip"=>"1.39.61.176","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109","location"=>"Maharashtra, IN"},{"ts"=>1424353602,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424353336,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424352956,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357103,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357106,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424676009,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"}],"clicks"=>[{"ts"=>1424351055,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"1.39.61.176","location"=>"Maharashtra, IN","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109"},{"ts"=>1424352960,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Chrome\/Chrome 40.0.2214.111"}],"smtp_events"=>[{"ts"=>1424348722,"type"=>"sent","diag"=>"250 2.0.0 uCRM1p0050GC7EE01 - uCRM1p0050GC7EE01CRMl8 mail accepted for delivery","source_ip"=>"198.2.132.12","destination_ip"=>"182.50.144.66","size"=>18929}],"subaccount"=>"cust-34","resends"=>[],"_version"=>"cbowxAqolAD54zD8LR4D1g","metadata"=>{"question_id"=>"11","campaign_name"=>"3rd round","user_id"=>"#{@biz_user.id}"},"sender"=>"kumareshc10@gmail.com","template"=>""}}]
       EmailActivity.save_payload(data)
       EmailActivity.all.count.should eql(1)
     end
     it "should update the mandrill payload activity for click if activity exist" do
       FactoryGirl.create(:email_activity,user_id: @biz_user.id,business_customer_info_id: @biz_customer_info.id, question_id: @weekly_question.id)
       data = [{"event"=>"click","ts"=>1424676009,"user_agent"=>"Mozilla\/5.0 (X11; Linux i686; rv=>31.0) Gecko\/20100101 Thunderbird\/31.4.0 Lightning\/3.3.2","user_agent_parsed"=>{"type"=>"Email Client","ua_family"=>"Thunderbird","ua_name"=>"Thunderbird 31.4.0","ua_version"=>"31.4.0","ua_url"=>"http=>\/\/www.mozilla.com\/en-US\/thunderbird\/","ua_company"=>"Mozilla Foundation","ua_company_url"=>"http=>\/\/www.mozilla.org\/","ua_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/thunderbird.png","os_family"=>"Linux","os_name"=>"Linux","os_url"=>"http=>\/\/en.wikipedia.org\/wiki\/Linux","os_company"=>"","os_company_url"=>"","os_icon"=>"http=>\/\/cdn.mandrill.com\/img\/email-client-icons\/linux.png","mobile"=>false},"ip"=>"111.93.148.94","location"=>{"country_short"=>"IN","country"=>"India","region"=>"Karnataka","city"=>"Bangalore","latitude"=>12.9762296677,"longitude"=>77.6032867432,"postal_code"=>"-","timezone"=>"+05=>30"},"_id"=>"f8e53b84370943afad0eef724860b0da","msg"=>{"ts"=>1424348720,"_id"=>"f8e53b84370943afad0eef724860b0da","state"=>"sent","subject"=>"3rd round","email"=>"#{@biz_customer_info.email}","tags"=>[],"opens"=>[{"ts"=>1424351055,"ip"=>"1.39.61.176","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109","location"=>"Maharashtra, IN"},{"ts"=>1424353602,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424353336,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424352956,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357103,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424357106,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"},{"ts"=>1424676009,"ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Thunderbird\/Thunderbird 31.4.0"}],"clicks"=>[{"ts"=>1424351055,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"1.39.61.176","location"=>"Maharashtra, IN","ua"=>"Mobile\/Android\/Android 4.4 KitKat\/Chrome Mobile\/Chrome Mobile 40.0.2214.109"},{"ts"=>1424352960,"url"=>"http=>\/\/inquir.ly\/17uxe1V?provider=Email&cid=NjEwNzQ=","ip"=>"111.93.148.94","location"=>"Karnataka, IN","ua"=>"Linux\/Linux\/Chrome\/Chrome 40.0.2214.111"}],"smtp_events"=>[{"ts"=>1424348722,"type"=>"sent","diag"=>"250 2.0.0 uCRM1p0050GC7EE01 - uCRM1p0050GC7EE01CRMl8 mail accepted for delivery","source_ip"=>"198.2.132.12","destination_ip"=>"182.50.144.66","size"=>18929}],"subaccount"=>"cust-34","resends"=>[],"_version"=>"cbowxAqolAD54zD8LR4D1g","metadata"=>{"question_id"=>"#{@weekly_question.id}","campaign_name"=>"3rd round","user_id"=>"#{@biz_user.id}"},"sender"=>"kumareshc10@gmail.com","template"=>""}}]
       EmailActivity.save_payload(data)
       EmailActivity.last.clicks.should eql(2)
     end
  end
end